name: Scrape BTM CSVs

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: "Símbolo a scrapear"
        required: true
        default: "SPX"
      strategy:
        description: "Estrategia (Vertical o IronCondor)"
        required: true
        default: "Vertical"
      riesgos:
        description: "Riesgos (conservador,intermedio,agresivo,ultra_agresivo) — vacío = auto"
        required: false
        default: ""
      horarios:
        description: "Horarios HH:MM (09:40,10:00,...) — vacío = auto"
        required: false
        default: ""
      desde:
        description: "YYYY-MM-DD — vacío = rango auto"
        required: false
        default: ""
      hasta:
        description: "YYYY-MM-DD — vacío = rango auto"
        required: false
        default: ""

permissions:
  contents: write

env:
  TZ: America/Monterrey

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run scraper
        env:
          BTM_EMAIL: ${{ secrets.BTM_EMAIL }}
          BTM_PASSWORD: ${{ secrets.BTM_PASSWORD }}
        run: |
          python scraper/btm_scraper.py \
            --symbol "${{ inputs.symbol }}" \
            --strategy "${{ inputs.strategy }}" \
            --risks "${{ inputs.riesgos }}" \
            --hours "${{ inputs.horarios }}" \
            --desde "${{ inputs.desde }}" \
            --hasta "${{ inputs.hasta }}" \
            --out-base "data"

      - name: Commit & push data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "chore(data): update CSVs [skip ci]"
            git push
          else
            echo "No hay cambios para commitear."
          fi

      - name: Upload CSVs as artifact (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-csvs
          path: data/
          if-no-files-found: warn
